# SQL 연습장 - 서브쿼리


## Q. 평균 주문 건수 보다 많이 주문한 고객을 찾으시오.

```sql
SELECT CONCAT( first_name, ' ', last_name)
FROM customer
WHERE customer_id IN (
	SELECT COUNT(*)
    FROM payment
    GROUP BY customer_id -- 고객별 주문 횟수
    HAVING COUNT(*) > (
		SELECT AVG(payment_count) -- 평균횟수
        FROM (
			SELECT COUNT(*) AS payment_count
            FROM payment
            GROUP BY customer_id
        )AS payment_counts
    ) -- FROM 에서 평균횟수구한 표 제작
);
```
> FROM 에 서브쿼리를 넣는 인라인 뷰

<br>
<br>

## Q. 가장 결제를 많이 한 고객을 찾으시오.

```sql
SELECT
CONCAT(first_name, ' ', last_name)
FROM
customer
WHERE
customer_id = (
	SELECT customer_id
    FROM (
		SELECT customer_id, COUNT(*) AS payment_count
        FROM payment
        GROUP BY customer_id
		) AS payment_counts
        ORDER BY payment_count DESC
        LIMIT 1
);
```

> 단일행 출력은 =, 여러행 출력은 IN

<br>
<br>


## Q. 각 고객에 대해 자신이 대여한 평균 영화길이(length) 보다 긴 영화들의 제목(title)을 찾아주세요.

```sql
SELECT C.first_name, C.last_name, F.title
FROM customer C
JOIN rental R ON C.customer_id = R.customer_id
JOIN inventory I ON I.inventory_id = R.inventory_id
JOIN film F ON F.film_id = I.film_id
WHERE F.length > (
	SELECT AVG(FIL.length)
    FROM film FIL
    JOIN inventory INV ON INV.film_id = FIL.film_id
    JOIN rental REN ON REN.inventory_id = INV.inventory_id
	WHERE REN.customer_id = C.customer_id
);
```
> 상관 서브쿼리

